name: CI

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ main ]

jobs:
  pre-clean-up:
    runs-on: self-hosted

    steps:
    - uses: actions/checkout@v4

    - name: Run pre-clean-up
      run: |
        # Load version variables
        source versions.sh
        
        GENERATOR_IMAGE_NAME="openvpn-generator:${IMAGE_VERSION}"
        CLIENT_BOOKWORM_IMAGE_NAME="openvpn-bookworm:${IMAGE_VERSION}"
        CLIENT_BULLSEYE_IMAGE_NAME="openvpn-bullseye:${IMAGE_VERSION}"
        CLIENT_JAMMY_IMAGE_NAME="openvpn-jammy:${IMAGE_VERSION}"
        CLIENT_FOCAL_IMAGE_NAME="openvpn-focal:${IMAGE_VERSION}"
        SERVER_IMAGE_NAME="openvpn:${IMAGE_VERSION}"
        
        echo "Image Version=${IMAGE_VERSION}"
        echo "OpenVPN Version=${OPENVPN_VERSION}"
        echo "IMAGE_NAME=${SERVER_IMAGE_NAME}"
        echo ""
        
        # Stop openvpn-generator if running
        if docker ps --filter "name=openvpn-generator" --format "{{.Names}}" | grep -q "openvpn-generator"; then
            echo "Stopping openvpn-generator container..."
            docker stop openvpn-generator
            echo "Waiting for openvpn-generator to stop..."
            while docker ps --filter "name=openvpn-generator" --format "{{.Names}}" | grep -q "openvpn-generator"; do
                sleep 1
            done
            echo "openvpn-generator stopped"
        else
            echo "Container openvpn-generator is not running, skipping..."
        fi
        
        # Stop openvpn-server if running
        if docker ps --filter "name=openvpn-server" --format "{{.Names}}" | grep -q "^openvpn-server"; then
            echo "Stopping openvpn-server container..."
            docker stop openvpn-server
            echo "Waiting for openvpn-server to stop..."
            while docker ps --filter "name=openvpn-server" --format "{{.Names}}" | grep -q "^openvpn-server"; do
                sleep 1
            done
            echo "openvpn-server stopped"
        else
            echo "Container openvpn-server is not running, skipping..."
        fi
        
        # Stop client-bookworm if running
        if docker ps --filter "name=client-bookworm" --format "{{.Names}}" | grep -q "^client-bookworm"; then
            echo "Stopping client-bookworm container..."
            docker stop client-bookworm
            echo "Waiting for client-bookworm to stop..."
            while docker ps --filter "name=client-bookworm" --format "{{.Names}}" | grep -q "^client-bookworm"; do
                sleep 1
            done
            echo "client-bookworm stopped"
        else
            echo "Container client-bookworm is not running, skipping..."
        fi
        
        echo ""

        # Remove containers if they exist
        if docker ps -a --format '{{.Names}}' | grep -q '^openvpn-generator$'; then
            docker rm openvpn-generator
            echo "openvpn-generator container removed"
        fi
        
        if docker ps -a --format '{{.Names}}' | grep -q '^openvpn-server$'; then
            docker rm openvpn-server
            echo "openvpn-server container removed"
        fi
        
        if docker ps -a --format '{{.Names}}' | grep -q '^client-bookworm$'; then
            docker rm client-bookworm
            echo "client-bookworm container removed"
        fi

        echo ""
        
        # Clean up old images
        echo "Removing older openvpn config generator image builds..."
        docker rmi -f "${GENERATOR_IMAGE_NAME}" 2>/dev/null || true
        docker rmi -f "${SERVER_IMAGE_NAME}" 2>/dev/null || true
        docker rmi -f "${CLIENT_BOOKWORM_IMAGE_NAME}" 2>/dev/null || true
        
        echo ""

        # Show current images
        echo "Listing all remaining images..."
        echo "# docker images"
        docker images

        echo ""

        # Clean docker networks
        docker network rm external 2>/dev/null || true
        docker network rm internal 2>/dev/null || true
        echo "Listing all remaining docker networks..."
        echo "# docker network ls"

  docker-image-build:
    runs-on: self-hosted
    needs: pre-clean-up
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build --no-cache -t openvpn-server:latest -f ./server/openvpn.dockerfile .

  trivy-scan:
    runs-on: self-hosted
    needs: docker-image-build
    steps:
    - uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      run: |
        trivy image \
          --severity HIGH,CRITICAL \
          --ignorefile .trivyignore \
          --exit-code 1 \
          --no-progress \
          --format table \
          openvpn-server:latest

  e2e-test:
    runs-on: self-hosted
    needs: trivy-scan
    steps:
    - uses: actions/checkout@v4
    
    - name: Run tests
      run: ./execute-test.sh
